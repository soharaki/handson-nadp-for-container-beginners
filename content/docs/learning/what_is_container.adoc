---
title: コンテナはなぜ動くのか?(前編)
weight: 30
---

++++
<h1>コンテナはなぜ動くのか?(前編)</h1>
++++

前章では仮想化技術の目的について振り返りました。
この章では、仮想化技術の内、比較的新しい技術である"コンテナ"について説明したいと思います。

コンテナを一言で説明するのは簡単です。

[quote]
____
コンテナとは、プロセスの実行空間を隔離するための技術です。
____

https://tech-lab.sios.jp/archives/18811[SIOSの武井さんもおっしゃっているように]
それだけの説明だとピンと来ないでしょう。

* プロセスって?
* 実行空間を隔離?
* Dockerとコンテナって違うの?

プロセスは一般用語ですが、多分LinuxOSを知っている人のプロセスと思い描いていることが違います。
そんな感じで一般用語と技術用語がいい感じに混ざって誤解を招くので、
Linuxの構造であるLinux kernelとuserspaceという、
コンテナとは一見関係なさそうなところから説明したいと思います。

## Linuxの構造

そもそもLinux OSとは何でしょうか。

https://qiita.com/uguis410/items/17ec1e447e9716bfdca7[【初心者向け】Linuxカーネルって一体なんだ?]がわかりやすかったので
それをベースに説明していきます。

「Linux」は、厳密には二つの意味で分けられます。

* 広義のLinux：Linuxディストリビューションのこと。
* 狭義のLinux：Linuxカーネルのこと。

コンテナを理解していくために必要なのは後者のLinuxカーネルの構造です。 +
Linuxサーバーの中身を覗いたとき、ざっくり次のような構造になっています。

{{<
figure src="/images/linuxserver.png"
>}}

1. ハードウェア
  - 物理マシン。システムの下部または基盤となり、メモリー (RAM) およびプロセッサーと呼ばれる中央処理装置 (CPU)、
    およびストレージ、ネットワーク、グラフィクスなどの入出力 (I/O) デバイスで構成されます。CPU は計算、メモリーからの読み取り、メモリーへの書き出しを実行します。
2. Linux カーネル
  - OS のコア(つまり中心部)。 メモリーに常駐するソフトウェアで、CPU に動作を命令します。
3. ソフトウェアユーザープロセス(略称: プロセス)
  - アプリケーション、ソフトウェア、あるいはプログラムのことです。

要は真ん中のLinuxOSが、ハードウェアとソフトウェアの仲立ちをしてくれて、
その中の機能でも中核を占めているのがLinuxカーネルです。

LinuxカーネルはそんなOSの基幹部分の機能である**「アプリケーションが動作するための基本環境」**を提供しています。

具体的には、

* メモリのどの場所にデータを保存すればいいか
* CPUのリソースをどの程度それぞれのアプリケーションに割り振ればいいか
* ハードウェアからの処理の依頼をどんな順番で行うか

など、普段コンピュータを操作する時に意識しない、後ろ側で動いているたくさんの基本的な機能をLinuxカーネルは提供してくれています。

また、大きく分けて役割は、

* アプリケーションからの要求に応えること。
* ハードウェアからの応答をアプリケーションに伝えること。

の2つに大別することができます。

そしてカーネルはアプリケーションからの要求に対して、
**システムコール**を介することで処理しています。

## システムコールとは

システムコールとは

[quote]
____
「非特権モードで動作しているプログラム」が「特権モードで動作しているカーネル」に処理を依頼すること
____

です。

{{<
figure src="/images/system_call.png"
>}}


カーネルはどのようなアプリケーションを動作させるためにも必要となる、共通の処理を担っているため、その性質上PC上の全てのリソースにアクセスできる特別な存在です。ただ、もし仮に他のそれぞれのプログラムが、カーネルと同じように好き勝手にPC上の全てのリソースをいじることができたら、一体どうなるでしょうか?

プログラムごとにメモリの値を書き換えてしまい、予期しない動作をするかもしれません。まして、PCが動くための基本的な情報や、カーネルを動かしているプログラムも、PC上のリソースのどこかに存在しているわけです。もしそれらの部分までいじられて影響を及ぼしてしまったら、重大なエラーが発生するだけでなく、最悪PCが停止する可能性があり、非常にリスキーです。

そこでLinuxカーネルではプログラムの実行環境を、

* 全てのリソースを扱うことができる、「カーネルモード」
* 一部のリソースしか扱うことができない、「ユーザーモード」

の二つの世界に分けています。

[NOTE]
====
カーネルモードのプログラムが動ける領域をLinux Kernel Space, ユーザーモードのプログラムが動ける領域をLinux User Spaceと評します。
====

ユーザーモードでは原則、他のプログラムに対して影響を与えるような動作をすることができません。したがって、他のプログラムに対して影響を与える心配がないので、安心してプログラムを動かすことができます。
他のプログラムに対して影響を与えるような操作を、普通のプログラムが行いたい場合は、システムコールを発行することで、カーネルに対して処理を依頼します。

カーネルに対しての窓口をシステムコールに絞ることで、プロセスに対する管理能力と安全性を高めています。

* 全ての処理をカーネルが統括することができるので、プログラム同士で処理のバッティングが起こらない。
* 不用意にプログラムが他のプログラムの内容を書き換えない。

などです。一般的にはLinuxのプロセスといった場合、 +
この **「ユーザーモード」で動いているプログラム** 一つ一つを指します。


## Linuxの構造、システムコールに関するまとめ

* Linuxは大きくハードウェア、LinuxOS、アプリケーションという構造に分かれていること
* LinuxOSのコア機能として、Linux Kernelという仕組みがあること
* Linux上のアプリケーションは、基本的にUserspace上のプロセスとして動いていること
* Linux用のアプリケーションは、システムコールを使用することでLinuxKernelの機能を操作したり、リソースにアクセスできること

## システムコールの種別と制限

Linuxの構造、システムコールが基本的なセキュリティの根幹にあることがわかったところで、
もう少し想像力を豊かにしてみましょう。そうするとシステムコールとプロセスという考え方では足りないことがわかります。

Linux上で色々なプログラム(プロセス)を動かしたい場合、各プロセスがもしも勝手にシステムコールを発行したらどうなるでしょう?

* 環境変数など、共通リソースの汚染
* ハードウェアの物理的限界を無視した、システム要求によるリソースの枯渇
* ほかのプロセスが使っているストレージなど、秘密したい情報へのアクセス

大惨事ですね。

これらの問題に対処するために、プロセスから呼び出せるシステムコール、あるいはアクセスできるリソースを制限、一括管理する仕組みとして様々な方法が考えられてきました。
その方法の一つがコンテナと呼ばれる**プロセスの実行空間を隔離するための技術**なのです。

## 次章: コンテナを支える三つの技術

すみません、長くなってしまったので後編へ続きます...

## 参考文献
* https://eh-career.com/engineerhub/entry/2019/02/05/103000
* https://itnext.io/breaking-down-containers-part-0-system-architecture-37afe0e51770
* https://tech-lab.sios.jp/archives/18811
* https://itnext.io/breaking-down-containers-part-0-system-architecture-37afe0e51770
* https://gihyo.jp/admin/serial/01/linux_containers/0002?page=1
* https://www2.slideshare.net/jpetazzo/cgroups-namespaces-and-beyond-what-are-containers-made-from-dockercon-europe-2015
* https://qiita.com/uguis410/items/17ec1e447e9716bfdca7